<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="jspsych/plugin-survey-html-form.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" /> 
  </head>
  <body></body>
  <script>

    var timeline = [];
    var playerGold = 0;
    var opponentGold = 0;
    var lastPlayerChoice = null; // Store player's last choice for opponent behaviour

    var jsPsych = initJsPsych();  

        var intro = {
            type: jsPsychHtmlButtonResponse,
            stimulus: "<p>Welcome to the Evolution of Trust Experiment!</p><p>First to reach 10 gold wins.</p>",
            choices: ["Start"]
        };

        timeline.push(intro);

        function getOpponentChoice() {
            if (lastPlayerChoice === null || lastPlayerChoice === 0) {
                return 0; // Cooperate by default or if the player last cooperated
            } else {
                return 1; // Cheat if the player last cheated
            }
        }

        function playRound() {
            if (playerGold >= 10 || opponentGold >= 10) {
                timeline.push({
                    type: jsPsychHtmlButtonResponse,
                    stimulus: `<p>Game Over! ${playerGold >= 10 ? "You win!" : "Opponent wins!"}</p>`,
                    choices: ["Restart"],
                    on_finish: function () {
                        playerGold = 0;
                        opponentGold = 0;
                        lastPlayerChoice = null;
                        jsPsych.init({ timeline: timeline, display_element: "jspsych-target" });
                    }
                });
                return;
            }

            var trial = {
                type: jsPsychHtmlButtonResponse,
                stimulus: `<p>You: ${playerGold} gold | Opponent: ${opponentGold} gold</p>
                           <p>Do you cooperate or cheat?</p>`,
                choices: ["Cooperate", "Cheat"],
                on_finish: function (data) {
                    var playerChoice = data.response;
                    var opponentChoice = getOpponentChoice();
                    lastPlayerChoice = playerChoice; // Store for next round

                    // Determine gold rewards
                    if (playerChoice === 0 && opponentChoice === 0) {
                        playerGold += 1;
                        opponentGold += 1;
                    } else if (playerChoice === 0 && opponentChoice === 1) {
                        opponentGold += 2;
                    } else if (playerChoice === 1 && opponentChoice === 0) {
                        playerGold += 2;
                    }

                    // Show results
                    timeline.push({
                        type: jsPsychHtmlButtonResponse,
                        stimulus: `<p>You chose ${playerChoice === 0 ? "Cooperate" : "Cheat"}.</p>
                                   <p>Opponent chose ${opponentChoice === 0 ? "Cooperate" : "Cheat"}.</p>
                                   <p>You: ${playerGold} gold | Opponent: ${opponentGold} gold</p>`,
                        choices: ["Next Round"],
                        on_finish: function () {
                            playRound();
                        }
                    });
                }
            };

            timeline.push(trial);
        }

        playRound();
        jsPsych.run(timeline);

  </script>
</html>
